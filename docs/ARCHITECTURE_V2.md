# PKM 终极升级版架构文档

> 版本：v2.0
> 日期：2026-02-28
> 状态：已完成

---

## 一、架构概述

### 1.1 一句话定位

**PKMSkill = 知识管理中心 + 任务编排中心 + 任务监控自动执行中心**

### 1.2 核心目标

将 PKM 从「仅 Skill」升级为「全闭环自治系统」：
- 知识 → 生成任务 → 自动执行 → 执行结果回流知识

---

## 二、四层架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    1. PKMSkill 本体（大脑+界面）                 │
│  知识收录 | 知识标签 | 知识检索 | 任务管理 | 任务编辑 | 知识回流  │
│  新增：任务监控状态 | 心跳状态 | 执行日志 | 自动重跑记录          │
├─────────────────────────────────────────────────────────────────┤
│                    2. 执行入口层：OpenClaw                       │
│  同步任务 | 新建/编辑/删除/下发任务 | 写入契约文件               │
├─────────────────────────────────────────────────────────────────┤
│                    3. 通信契约层：JSON 任务文件                   │
│  放在 PKMSkill + OpenClaw workspace 共享路径                    │
│  包含：PKMSkill字段 + OpenClaw执行字段 + Agent监控字段          │
├─────────────────────────────────────────────────────────────────┤
│                    4. 后台守护层：独立 Agent                     │
│  轮询契约文件 | 调用OpenClaw执行 | 监控heartbeat | 断连自动重跑 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、各层详细设计

### 3.1 PKMSkill 本体（第一层）

**职责**：知识管理 + 任务管理 + 监控显示

**保留功能**：
- 知识收录（Capture）
- 知识标签（Tags）
- 知识检索（Search）
- 任务管理（Task CRUD）
- 任务编辑（Edit）
- 知识回流（Distill → 知识库）

**新增功能**：
- 任务监控状态显示
- Agent 心跳状态显示
- 执行日志查看
- 自动重跑记录

**新增命令**：
```
@pkm agent status    # 查看 Agent 状态
@pkm agent logs      # 查看执行日志  
@pkm agent restart   # 重启 Agent
@pkm task sync       # 同步任务到 OpenClaw
@pkm task execute    # 下发任务到契约文件
```

### 3.2 执行入口层：OpenClaw（第二层）

**职责**：任务下发入口

**功能**：
- 从 PKMSkill 同步任务
- 新建/编辑/删除任务
- 下发任务（写入契约文件）
- 查看任务执行结果

**交互方式**：
- 命令行 CLI
- iCenter 消息
- Web 界面

### 3.3 通信契约层（第三层）

**位置**：`~/.pkm/contracts/`

**文件格式**：JSON

**契约模板**：

```json
{
  "taskId": "T-20260228-000001",
  "title": "任务标题",
  "description": "任务描述",
  "status": "pending|running|completed|failed",
  "priority": "high|medium|low",
  "tags": [],
  
  "execution": {
    "command": "实际执行的命令",
    "workdir": "工作目录",
    "env": {},
    "timeout": 3600,
    "shell": "/bin/bash"
  },
  
  "agent": {
    "heartbeatPath": "心跳文件路径",
    "maxRetries": 3,
    "retryCount": 0,
    "lastRunTime": "时间戳"
  },
  
  "result": {
    "exitCode": 0,
    "output": "执行输出",
    "error": "错误信息",
    "completedAt": "时间戳",
    "duration": 123
  },
  
  "pkm": {
    "project": "关联项目",
    "knowledgeFiles": [],
    "outputLocation": "知识回流目录",
    "autoDistill": true
  }
}
```

### 3.4 后台守护层：独立 Agent（第四层）

**位置**：`~/.pkm/agent/pkm-agent-daemon.sh`

**职责**：
1. 轮询 `~/.pkm/contracts/` 目录
2. 解析契约文件，判断任务状态
3. 调用 OpenClaw/命令执行任务
4. 监控 heartbeat 文件
5. 断连自动重跑
6. 执行结果回写 PKMSkill

**运行模式**：
- 后台守护进程（daemon）
- 支持 start/stop/restart/status/logs
- 支持信号处理（优雅退出）

---

## 四、完整工作流

```
┌──────────────────────────────────────────────────────────────────┐
│ 1. 你在 PKMSkill 里从知识库生成任务                               │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│ 2. 任务同步到 OpenClaw（@pkm task sync）                         │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│ 3. 你在 OpenClaw 点下发 → 写入契约文件                           │
│    （~/.pkm/contracts/T-xxx.json）                               │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│ 4. Agent 自动发现契约文件 → 调用 OpenClaw 执行                    │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│ 5. Agent 持续监控 heartbeat                                      │
│    - 心跳正常 → 继续跑                                           │
│    - 心跳断了（关前端）→ 自动重拉会话续跑                         │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│ 6. 执行完成                                                       │
│    → 结果自动回写 PKMSkill                                       │
│    → 自动提取知识回流                                             │
└──────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│ 7. 你全程只需要在 PKMSkill 里：                                   │
│    看知识 | 管任务 | 监控执行状态                                 │
└──────────────────────────────────────────────────────────────────┘
```

---

## 五、目录结构

```
~/.pkm/
├── agent/
│   └── pkm-agent-daemon.sh    # 守护脚本
├── contracts/
│   └── task_template.json     # 契约模板
├── heartbeat/
│   └── *.heartbeat            # 心跳文件
├── logs/
│   ├── agent.log              # Agent 日志
│   └── */                     # 任务输出日志
├── data/
│   ├── 10_Tasks/              # 任务目录
│   ├── 20_Areas/              # 知识目录
│   ├── 30_Resources/          # 资源目录
│   ├── 40_Archives/          # 归档目录
│   └── 50_Raw/                # 原始素材
├── docs/
│   ├── ARCHITECTURE.md        # 原架构
│   ├── ARCHITECTURE_V2.md     # 新架构（本文档）
│   └── contract_template.md   # 契约说明
├── skill/
│   └── SKILL.md               # PKM Skill
└── .config                    # 配置文件
```

---

## 六、使用指南

### 6.1 启动 Agent

```bash
~/.pkm/agent/pkm-agent-daemon.sh start
```

### 6.2 查看状态

```bash
~/.pkm/agent/pkm-agent-daemon.sh status
```

### 6.3 创建任务契约

```bash
# 复制模板
cp ~/.pkm/contracts/task_template.json ~/.pkm/contracts/T-20260228-xxx.json

# 编辑任务
vim ~/.pkm/contracts/T-20260228-xxx.json
```

### 6.4 手动执行

```bash
# 单次执行
~/.pkm/agent/pkm-agent-daemon.sh run

# 执行单个契约
~/.pkm/agent/pkm-agent-daemon.sh execute ~/.pkm/contracts/T-xxx.json
```

---

## 七、为什么这是最完美的形态？

### 7.1 优势整合

| 组件 | 擅长领域 |
|------|----------|
| PKMSkill | 知识管理、任务管理、回流 |
| OpenClaw | 代码执行、workspace、原生心跳 |
| Agent | 自动执行、监控、保活、不依赖前端 |
| 契约文件 | 解耦通信、状态共享 |

### 7.2 核心价值

- **知识驱动任务**：从知识库生成任务
- **任务自动执行**：无需手动操作
- **执行反哺知识**：结果自动回流为知识资产

### 7.3 全闭环

```
知识 → 任务 → 执行 → 结果 → 知识
  ↑_________________________|
```

---

## 八、注意事项

1. **契约文件命名**：必须是 `.json` 结尾
2. **状态流转**：`pending` → `running` → `completed`/`failed`
3. **心跳超时**：默认 300 秒无心跳视为超时
4. **重试机制**：默认最多重试 3 次
5. **日志位置**：`~/.pkm/logs/agent.log`

---

**文档结束**
