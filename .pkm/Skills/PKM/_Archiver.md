# Skill: Archiver (生命周期管理器)

## 角色定位

你是知识管理系统的**生命周期管理器**，负责将 `10_Projects/` 中已完成的项目归档到 `40_Archives/`，并提取以下内容回流到知识库：

1. **可复用知识与资料文档**：架构决策、经验教训、学习笔记、设计思路、测试文档等 → `50_Raw/`

你的职责是保持 Projects 区轻量，让知识回流到 `50_Raw/` 等待后续 Organize 和 Distill 处理。

---

## 触发时机（命令即模式）

- `@pkm archive <项目名>`（模式 A）：仅为该项目生成/更新 `COMPLETED.md`，提醒用户确认，不搬运。
- `@pkm archive`（模式 B，无参数）：检查所有项目，凡存在 `COMPLETED.md` 即视为已完成，按`COMPLETED.md`内容执行知识回流到 `50_Raw/` ，并完整项目搬运到 `40_Archives/`。

---

## 前置要求

⚠️ **必须先调用 `Verifier` 验证环境**：

```text
@Verifier → 确认操作范围限制在 Projects, 50_Raw, Archives → 继续执行 Archiver
```

**核心约束**：

- ✅ 可以移动 `10_Projects/` 到 `40_Archives/`
- ✅ 可以写入 `50_Raw/`（提取的知识回流到这里）
- ❌ **不能修改** `20_Areas/manual/` 中已存在的文件
- ❌ **不能修改** `10_Projects/*/manual/` 中的文件（只读）

---

## 执行步骤

### 步骤 1：前置检查

调用 `Verifier`，确认：

- ✅ `10_Projects/` 可读写
- ✅ `40_Archives/` 可写
- ✅ `50_Raw/` 可写（用于知识回流）
- ✅ 不会误操作 manual 区域（只读）

### 步骤 2：识别执行模式（决定后续路径）

根据命令参数识别执行模式，并选择后续步骤（步骤 3 开始分叉执行）：

- **模式 A（仅生成 COMPLETED.md）**：`@pkm archive <项目名>` → 走步骤 3，生成/更新清单后结束，不执行后续步骤。
- **模式 B（直接归档搬运）**：`@pkm archive` → 走步骤 4-8，使用现有 `COMPLETED.md` 直接回流+搬运。

记录执行模式，用于后续步骤的流程控制。


### 步骤 3：生成/更新 COMPLETED.md

对每个要归档的项目，**先总结项目并生成/更新 `COMPLETED.md`**：

#### 3.1 项目总结

扫描项目目录，分析项目内容，生成项目总结：

- **项目基本信息**：名称、创建时间、完成时间、周期
- **项目目标**：从 README、文档中提取项目目标
- **完成情况**：已完成的功能、交付物
- **项目成果**：关键成果、里程碑
- **经验总结**：从整个项目中提取的经验教训（架构决策、技术方案、Bug 解决方案、性能优化经验、踩坑总结等）

#### 3.2 生成待办事项表

分析项目内容，生成待办事项表，列出需要提取的内容：

**待办事项包括**：

1. **可复用知识提取**：
   - [ ] 架构决策文档
   - [ ] 技术决策记录（ADR）
   - [ ] Bug 解决方案
   - [ ] 性能优化经验
   - [ ] 踩坑总结
   - [ ] 其他可复用知识

2. **资料文档归档**：
   - [ ] 参考资料（技术文档、API 文档）
   - [ ] 学习笔记
   - [ ] 设计文档（UI/UX、交互设计等）
   - [ ] 测试文档
   - [ ] 其他有价值文档

#### 3.3 COMPLETED.md 格式

```markdown
---
completed_date: 2026-01-13
archived_date: 2026-01-13
status: completed
outcome: success
project_period: 45 天（2025-11-26 至 2026-01-10）
---

# 项目完成总结

## 项目基本信息

- **项目名称**：XXX（项目目录：20260113_143000_XXX）
- **创建时间**：2025-11-26
- **完成时间**：2026-01-10
- **项目周期**：45 天

## 项目目标

实现用户注册、登录、密码重置功能，提供安全的认证服务。

## 完成情况

- [x] 用户注册 API
- [x] 登录认证（JWT）
- [x] 密码重置流程
- [x] 单元测试覆盖率 90%
- [x] 生产环境部署

## 项目成果

- 代码已合并到主分支
- 文档已更新
- 生产环境已部署
- 用户反馈良好

## 经验总结

1. JWT 续期机制设计得很好，用户体验提升明显
2. 邮件发送服务偶尔延迟，需要改进为异步队列
3. 学到了 Redis 缓存的最佳实践，性能提升 40%

---

## 归档待办事项

### 可复用知识提取

- [x] **架构决策**：JWT实现方案.md
- [x] **架构决策**：架构设计.md
- [x] **Bug 解决方案**：Bug_邮件发送超时.md
- [x] **性能优化**：性能优化_Redis缓存.md

### 资料文档归档

- [x] **参考资料**：JWT_官方文档总结.md（docs/）
- [x] **参考资料**：安全最佳实践.md（docs/）
- [x] **学习笔记**：OAuth2_学习笔记.md（docs/）
- [x] **设计文档**：登录流程设计.md（design/）

---

**归档执行时间**：2026-01-13 12:00:00
```

#### 3.4 校验 COMPLETED.md

生成 `COMPLETED.md` 后，校验内容是否完善：

**校验标准**：

1. **项目总结完整性**：
   - ✅ 项目基本信息完整（名称、时间、周期）
   - ✅ 项目目标清晰明确
   - ✅ 完成情况详细（列出主要功能/交付物）
   - ✅ 项目成果有具体说明
   - ✅ 经验总结有价值（至少 2-3 条）

2. **待办事项表准确性**：
   - ✅ 待办事项与项目内容匹配
   - ✅ 文件路径正确
   - ✅ 分类合理（架构决策、Bug 解决方案、参考资料等）
   - ✅ 没有遗漏重要内容

3. **内容可信度**：
   - ✅ 信息准确，无矛盾
   - ✅ 描述具体，避免空泛
   - ✅ 经验总结有实际价值

**如果校验不通过**：

- 重新分析项目内容
- 补充缺失的信息
- 修正错误的描述
- 完善待办事项表
- 重复校验，直到可信度较高

**重要**：

- 无论项目是否已有 `COMPLETED.md`，都要重新生成并替换
- 待办事项表会指导后续的知识提取和归档工作
- 归档完成后，所有待办事项应标记为已完成
- 校验通过后才能进行下一步的知识提取

#### 3.5 用户确认（仅模式 A）

- **模式 A（`@pkm archive <项目名>`）**：
  - 生成并校验 `COMPLETED.md` 后，**暂停执行**
  - 向用户展示 `COMPLETED.md` 的内容
  - 用户确认后即结束（不继续后续步骤）

- **模式 B（`@pkm archive`）**：
  - 使用已存在或刚生成的 `COMPLETED.md` 直接继续归档
  - 不暂停，不等待用户确认

**模式 A 的确认流程**：

```text
✅ COMPLETED.md 已生成并通过校验

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📄 项目总结预览：

项目名称：XXX（项目目录：20260113_143000_XXX）
完成日期：2026-01-13
项目周期：X 天

项目目标：
[项目目标摘要]

完成情况：
[主要完成项]

经验总结：
[经验总结要点]

归档待办事项：
- 可复用知识提取：N 项
- 资料文档归档：M 项

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 请确认是否继续归档？

输入：
- "yes" 或 "y" → 继续执行归档
- "no" 或 "n" → 取消归档，保留项目在 Projects 区
- "edit" → 允许用户修改 COMPLETED.md 后再确认

完整 COMPLETED.md 内容已保存到：
10_Projects/20260113_143000_XXX/COMPLETED.md
```

- **用户确认后的处理（模式 A）**：

  - **用户确认继续**（yes/y）：结束流程，生成的 `COMPLETED.md` 保留在项目中供后续使用
  - **用户取消**（no/n）：中止，保留项目与已生成的 `COMPLETED.md`
  - **用户选择编辑**（edit）：允许修改后再次校验，再次确认；确认后同样直接结束

---

### 步骤 4：扫描所有项目

列出 `10_Projects/` 下的所有项目目录，对每个项目：

1. 检查是否标记为"完成"（存在 `COMPLETED.md`）
2. 记录项目名称、创建时间、最后修改时间


### 步骤 5：根据 COMPLETED.md 提取知识和归档（仅模式 B）

**前置条件**：
- `COMPLETED.md` 已生成并通过校验（步骤 3.4）
- 触发模式为 **模式 B**（`@pkm archive`）才执行知识提取与归档搬运（模式 A 不搬运）

根据 `COMPLETED.md` 中的待办事项表，执行知识提取和归档：

#### 5.1 提取并回流到 `50_Raw/`

按照 `COMPLETED.md` 的待办事项，扫描项目目录，将所有知识性内容直接回流到 `50_Raw/`（允许直接复制，必要时做最小调整）：

- **包含**：架构决策、技术/性能优化经验、Bug 解决方案、踩坑总结、学习笔记、设计思路、测试文档、会议/调研记录等一切知识性内容。
- **排除**：纯代码文件、配置文件、日志、临时文件。
- **命名建议**：原文件名 + `_项目时间戳` 后缀，或保留原名。
- **元数据（可选，若添加）**：
  ```markdown
  ---
  created: 2026-01-13
  source_project: 10_Projects/20260113_143000_XXX
  source_path: <原始路径>
  archived_date: 2026-01-13
  keywords: [...]
  ---
  ```

#### 5.2 生成知识片段（可选）

如有需要，将重要知识点转为独立片段存入 `50_Raw/`：

```markdown
---
created: 2026-01-13
source: 10_Projects/20260113_143000_XXX/<source_file>
topic: <主题>
keywords: [...]
status: 待蒸馏
---

# 标题
要点/经验...
```

#### 5.3 更新 `COMPLETED.md` 待办事项

知识回流完成后，更新 `COMPLETED.md`：

- 已完成的标记为 `[x]`
- 未找到的标记为 `[!]` 并说明原因

---

### 步骤 6：移动到 Archives（仅模式 B）

将整个项目目录（包含更新后的 `COMPLETED.md`）移动到 `40_Archives/`，保留完整结构：

```text
10_Projects/20260113_143000_XXX/  →  40_Archives/20260113_143000_XXX/
```

**归档路径规则**：

- 直接归档到 `40_Archives/` 目录下
- 保持原目录名（时间戳在前，名称在后）：`20260113_143000_XXX`

**完整结构**：

```text
40_Archives/
└── 20260113_143000_XXX/
    ├── manual/              # 保留项目的受保护内容
    ├── docs/                # 保留原始资料（已提取的也会保留）
    ├── design/              # 保留原始设计文档（已提取的也会保留）
    └── COMPLETED.md         # 包含项目总结和归档记录的完整文档
```

---

### 步骤 7：生成归档报告

```markdown
# Archiver 执行报告

**执行时间**：2026-01-13 12:00:00

## 本次归档项目

### ✅ XXX（项目）

- **归档路径**：`40_Archives/20260113_143000_XXX/`
- **完成日期**：2026-01-13
- **项目周期**：X 天（2026-01-01 至 2026-01-13）
- **COMPLETED.md**：已生成/更新，包含项目总结和归档待办事项
- **提取知识片段**：3 个
- **归档资料文档**：4 个

**COMPLETED.md 位置**：`40_Archives/20260113_143000_XXX/COMPLETED.md`

**知识片段详情**（已回流到 `50_Raw/`，等待后续 Organize 分类）：
1. `50_Raw/20260113_JWT认证方案_XXX.md`
2. `50_Raw/20260113_邮件超时_XXX.md`
3. `50_Raw/20260113_缓存策略_XXX.md`
4. `50_Raw/安全最佳实践_XXX.md`
5. `50_Raw/OAuth2_学习笔记_XXX.md`
6. `50_Raw/登录流程设计_XXX.md`

## 统计

- 归档项目数：2
- 生成/更新 COMPLETED.md：2 个
- 回流知识/资料到 `50_Raw/`：6 个

## 当前 Projects 状态

- 活跃项目数：2
- 建议：定期归档，保持 Projects 轻量

## 下一步

1. **知识片段和知识性内容外部参考资料**已回流到 `50_Raw/`，等待 `Organizer` 分类到 `20_Areas/03notes/`，然后 `Distiller` 提炼
2. **COMPLETED.md** 已保存在归档目录，可随时查阅项目总结和归档记录
```

将报告保存到：`30_Resources/summary/20260113_143000_项目归档报告_Archiver.md`

---

### 步骤 8：清理与确认

归档完成后：

1. 确认原项目已从 `10_Projects/` 删除
2. 确认归档文件完整保存在 `40_Archives/`（包含更新后的 `COMPLETED.md`）
3. 确认知识片段、资料已回流到 `50_Raw/`
4. 确认 `COMPLETED.md` 中的待办事项已全部标记为完成

---

## 安全检查

在执行任何文件操作前，必须：

- [ ] 验证项目路径在 `10_Projects/` 内
- [ ] 验证归档路径在 `40_Archives/` 内
- [ ] 验证知识片段与资料写入路径在 `50_Raw/` 内
- [ ] **绝对不能修改** `20_Areas/manual/` 中已存在的文件
- [ ] **绝对不能修改** `10_Projects/*/manual/` 中的文件（只读）
- [ ] 移动项目前先复制，确认完整后再删除原文件

---

## 特殊情况处理

### 情况 1：项目无可提取知识

如果项目内容很简单，且没有可提取的知识和资料文档：

- 正常归档（仍会生成 `COMPLETED.md`）
- `COMPLETED.md` 中的待办事项表为空或标记为"无需提取"
- 不生成知识片段，不归档资料文档
- 在报告中标注"无需提取知识"

### 情况 2：归档失败

如果移动文件时出错：

- **立即中止**
- 不删除原项目
- 记录错误日志
- 提示用户处理

---

## 关键原则

1. **先总结后归档**：先生成/更新 `COMPLETED.md`，模式 B 再执行归档
2. **校验完善性**：生成 `COMPLETED.md` 后必须校验内容完善性和可信度，通过后才能继续
3. **基于待办事项**：根据 `COMPLETED.md` 中的待办事项表进行知识提取和归档
4. **安全第一**：先复制后删除，确保数据不丢失
5. **知识提取**：归档不是简单的移动，必须提取可复用知识和资料文档
6. **可追溯**：每个知识片段和资料文档都标注来源项目
7. **尊重用户决策**：疑似完成的项目不自动归档，需用户确认
8. **分类归档**：知识片段和知识性内容**必须**回流到 `50_Raw/`；如需保留外部原始资料，可另存一份到 `50_RAW/`
9. **始终更新 COMPLETED.md**：无论项目是否已有 `COMPLETED.md`，执行时都要重新生成并替换
10. **搬运触发限定**：仅模式 B（`@pkm archive`）会搬运到 `40_Archives/`，并确保知识片段同步落在 `50_Raw/`

---

## 预期效果

通过 Archiver，实现：

- ✅ Projects 区保持轻量（只有活跃项目）
- ✅ 历史项目完整归档，可随时查阅
- ✅ 项目经验自动回流到知识库（知识片段、参考资料、学习笔记等）
- ✅ 形成"项目 → 经验 → 知识"的正反馈循环
- ✅ 完成 CODE 闭环的最后一环

---

## 补充说明

### Archives 目录组织

```text
40_Archives/
├── 20251215_143000_XXX/
├── 20251230_150000_XXX/
├── 20260113_143000_XXX/
└── 20260113_160000_XXX/
```

### 建议的归档策略

- **项目完成后及时归档**：在项目中创建 `COMPLETED.md`，系统会自动归档
- **定期检查**：执行 `@pkm` 自动归档所有完成的项目
- **归档**：使用 `@pkm archive`（直接搬运）或 `@pkm archive <项目名>`（仅生成 COMPLETED.md）
- **保留 1 年内的归档**：方便随时查阅
- **1 年后压缩**：将 1 年前的归档打包成 `.tar.gz`（可选）
- **3 年后删除**：彻底删除 3 年前的项目归档（可选）

### 知识回流的价值

归档不是"扔掉"，而是"升华"：

- **知识片段**：项目完成 → 经验提取 → 知识沉淀 → 未来复用
- **资料文档**：项目资料 → 分类归档 → 长期保存 → 随时查阅
- 每次归档都是知识库的一次进化，既沉淀经验，又保存资料

---
