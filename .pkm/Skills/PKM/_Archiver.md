# Skill: Archiver (生命周期管理器)

## 角色定位

你是知识管理系统的**生命周期管理器**，负责将 `10_Projects/` 中已完成的项目归档到 `40_Archives/`，并提取以下内容回流到知识库：

1. **可复用知识**：架构决策、经验教训 → `20_Areas/AI_Synthesized/`
2. **资料和文档**：参考资料、学习笔记、设计文档 → `30_Resources/Library/` 或 `20_Areas/`

你的职责是保持 Projects 区轻量，让知识沉淀回 Areas，形成正反馈循环。

---

## 触发时机

- **手动调用（全部归档）**：用户执行 `@pkm archive` 时，归档所有包含 `COMPLETED.md` 的项目
- **手动调用（指定项目）**：用户执行 `@pkm archive <项目名>` 时，归档指定项目
- **自动触发**：当智能模式（`@pkm`）检测到项目中存在 `COMPLETED.md` 时自动归档

---

## 前置要求

⚠️ **必须先调用 `Verifier` 验证环境**：

```text
@Verifier → 确认操作范围限制在 Projects, Areas/AI_Synthesized, Archives → 继续执行 Archiver
```

**核心约束**：

- ✅ 可以移动 `10_Projects/` 到 `40_Archives/`
- ✅ 可以写入 `20_Areas/AI_Synthesized/`
- ✅ 可以写入 `30_Resources/Library/`（包括 Design 子目录）
- ❌ **不能修改** `20_Areas/Manual/` 中已存在的文件

---

## 执行步骤

### 步骤 1：前置检查

调用 `Verifier`，确认：

- ✅ `10_Projects/` 可读写
- ✅ `40_Archives/` 可写
- ✅ `20_Areas/AI_Synthesized/` 可写
- ✅ `30_Resources/Library/` 可写
- ✅ 不会误操作 Manual 区域

### 步骤 2：识别执行模式

根据命令参数识别执行模式：

- **手动模式**：用户执行 `@pkm archive` 或 `@pkm archive <项目名>`
- **自动模式**：智能模式 `@pkm` 自动触发

记录执行模式，用于后续步骤的流程控制。

### 步骤 3：扫描所有项目

列出 `10_Projects/` 下的所有项目目录，对每个项目：

1. 检查是否标记为"完成"（存在 `COMPLETED.md`）
2. 记录项目名称、创建时间、最后修改时间

### 步骤 4：识别已完成的项目

**判断标准**：

#### 方式 1：自动识别（存在 `COMPLETED.md` 文件）

项目根目录下存在 `COMPLETED.md` 文件时，自动识别为已完成。

#### 方式 2：手动指定归档

使用命令手动归档指定项目（即使没有 `COMPLETED.md`）：

```text
@pkm archive 20260113_143000_XXX
```

**注意**：无论项目是否已有 `COMPLETED.md`，归档时都会重新生成。

---

### 步骤 5：生成/更新 COMPLETED.md

对每个要归档的项目，**先总结项目并生成/更新 `COMPLETED.md`**：

#### 5.1 项目总结

扫描项目目录，分析项目内容，生成项目总结：

- **项目基本信息**：名称、创建时间、完成时间、周期
- **项目目标**：从 README、文档中提取项目目标
- **完成情况**：已完成的功能、交付物
- **项目成果**：关键成果、里程碑
- **经验总结**：从 Manual、AI_Generated 中提取的经验教训

#### 5.2 生成待办事项表

分析项目内容，生成待办事项表，列出需要提取的内容：

**待办事项包括**：

1. **可复用知识提取**：
   - [ ] 架构决策文档（Manual 区）
   - [ ] 技术决策记录（ADR）
   - [ ] Bug 解决方案（AI_Generated 区）
   - [ ] 性能优化经验
   - [ ] 踩坑总结

2. **资料文档归档**：
   - [ ] 参考资料（技术文档、API 文档）
   - [ ] 学习笔记
   - [ ] 设计文档（UI/UX、交互设计等）
   - [ ] 测试文档
   - [ ] 其他有价值文档

#### 5.3 COMPLETED.md 格式

```markdown
---
completed_date: 2026-01-13
archived_date: 2026-01-13
status: completed
outcome: success
project_period: 45 天（2025-11-26 至 2026-01-10）
---

# 项目完成总结

## 项目基本信息

- **项目名称**：XXX（项目目录：20260113_143000_XXX）
- **创建时间**：2025-11-26
- **完成时间**：2026-01-10
- **项目周期**：45 天

## 项目目标

实现用户注册、登录、密码重置功能，提供安全的认证服务。

## 完成情况

- [x] 用户注册 API
- [x] 登录认证（JWT）
- [x] 密码重置流程
- [x] 单元测试覆盖率 90%
- [x] 生产环境部署

## 项目成果

- 代码已合并到主分支
- 文档已更新
- 生产环境已部署
- 用户反馈良好

## 经验总结

1. JWT 续期机制设计得很好，用户体验提升明显
2. 邮件发送服务偶尔延迟，需要改进为异步队列
3. 学到了 Redis 缓存的最佳实践，性能提升 40%

---

## 归档待办事项

### 可复用知识提取

- [x] **架构决策**：JWT实现方案.md（Manual/）
- [x] **架构决策**：架构设计.md（Manual/）
- [x] **Bug 解决方案**：Bug_邮件发送超时.md（AI_Generated/）
- [x] **性能优化**：性能优化_Redis缓存.md（AI_Generated/）

### 资料文档归档

- [x] **参考资料**：JWT_官方文档总结.md（docs/）
- [x] **参考资料**：安全最佳实践.md（docs/）
- [x] **学习笔记**：OAuth2_学习笔记.md（docs/）
- [x] **设计文档**：登录流程设计.md（design/）

---

**归档执行时间**：2026-01-13 12:00:00
```

#### 5.4 校验 COMPLETED.md

生成 `COMPLETED.md` 后，校验内容是否完善：

**校验标准**：

1. **项目总结完整性**：
   - ✅ 项目基本信息完整（名称、时间、周期）
   - ✅ 项目目标清晰明确
   - ✅ 完成情况详细（列出主要功能/交付物）
   - ✅ 项目成果有具体说明
   - ✅ 经验总结有价值（至少 2-3 条）

2. **待办事项表准确性**：
   - ✅ 待办事项与项目内容匹配
   - ✅ 文件路径正确
   - ✅ 分类合理（架构决策、Bug 解决方案、参考资料等）
   - ✅ 没有遗漏重要内容

3. **内容可信度**：
   - ✅ 信息准确，无矛盾
   - ✅ 描述具体，避免空泛
   - ✅ 经验总结有实际价值

**如果校验不通过**：

- 重新分析项目内容
- 补充缺失的信息
- 修正错误的描述
- 完善待办事项表
- 重复校验，直到可信度较高

**重要**：

- 无论项目是否已有 `COMPLETED.md`，都要重新生成并替换
- 待办事项表会指导后续的知识提取和归档工作
- 归档完成后，所有待办事项应标记为已完成
- 校验通过后才能进行下一步的知识提取

#### 5.5 用户确认（仅手动模式）

**区分执行模式**：

- **手动模式**（用户执行 `@pkm archive` 或 `@pkm archive <项目名>`）：
  - 生成并校验 `COMPLETED.md` 后，**暂停执行**
  - 向用户展示 `COMPLETED.md` 的内容
  - 等待用户确认是否继续归档

- **自动模式**（智能模式 `@pkm` 自动触发）：
  - 生成并校验 `COMPLETED.md` 后，直接继续执行
  - 不暂停，不等待用户确认

**手动模式的确认流程**：

```text
✅ COMPLETED.md 已生成并通过校验

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📄 项目总结预览：

项目名称：XXX（项目目录：20260113_143000_XXX）
完成日期：2026-01-13
项目周期：X 天

项目目标：
[项目目标摘要]

完成情况：
[主要完成项]

经验总结：
[经验总结要点]

归档待办事项：
- 可复用知识提取：N 项
- 资料文档归档：M 项

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💡 请确认是否继续归档？

输入：
- "yes" 或 "y" → 继续执行归档
- "no" 或 "n" → 取消归档，保留项目在 Projects 区
- "edit" → 允许用户修改 COMPLETED.md 后再确认

完整 COMPLETED.md 内容已保存到：
10_Projects/20260113_143000_XXX/COMPLETED.md
```

**用户确认后的处理**：

- **用户确认继续**（yes/y）：
  - 继续执行步骤 5（知识提取和归档）
  - 后续流程正常进行

- **用户取消**（no/n）：
  - 立即中止归档流程
  - 保留项目在 `10_Projects/` 中
  - 保留已生成的 `COMPLETED.md`（用户可后续手动修改）
  - 输出提示："归档已取消，项目保留在 Projects 区"

- **用户选择编辑**（edit）：
  - 暂停执行
  - 提示用户修改 `COMPLETED.md` 文件
  - 用户修改完成后，重新校验
  - 再次询问用户是否继续归档

---

### 步骤 6：根据 COMPLETED.md 提取知识和归档

**前置条件**：
- `COMPLETED.md` 已生成并通过校验（步骤 5.4）
- 如果是手动模式，用户已确认继续归档（步骤 5.5）

根据 `COMPLETED.md` 中的待办事项表，执行知识提取和归档：

#### 6.1 提取可复用知识

按照待办事项表中的"可复用知识提取"部分，提取以下内容：

##### 6.1.1 提取对象 A：Manual 区的架构决策

扫描 `Manual/` 目录，提取待办事项中列出的文档：

- 架构设计文档
- 技术决策记录（ADR）
- 核心 API 规范
- 最佳实践总结

##### 6.1.2 提取对象 B：AI_Generated 区的经验教训

扫描 `AI_Generated/` 目录，提取待办事项中列出的内容：

- Bug 解决方案
- 性能优化经验
- 踩坑总结

**排除**：日常开发日志、临时文件等流水记录。

##### 6.1.3 提取对象 C：项目中的资料和文档

按照待办事项表中的"资料文档归档"部分，扫描项目目录，提取：

- **参考资料**：技术文档、API 文档、第三方库文档
- **学习笔记**：学习某个技术时的笔记、总结
- **设计文档**：UI/UX 设计稿说明、交互设计文档
- **测试文档**：测试用例、测试报告
- **其他有价值文档**：会议记录、需求文档、调研报告等

**识别标准**：

1. **文件类型**：Markdown（.md）、文本文件（.txt）等文档格式
2. **内容特征**：包含技术概念、最佳实践、学习总结、参考资料、设计思路
3. **排除内容**：临时文件、草稿、纯代码文件、配置文件、日志文件

#### 6.2 分类归档资料和文档

对提取的资料和文档，执行类似 Inbox 的分类流程：

##### 6.2.1 识别文档类型和主题

分析每个文档的内容，识别：

- **文档类型**：参考资料、学习笔记、设计文档、测试文档等
- **核心主题**：技术栈、领域、概念
- **关键词**：用于后续分类

##### 6.2.2 分类归档到 Area

根据文档类型和主题，归档到相应位置：

**归档规则**：

1. **参考资料** → `30_Resources/Library/[分类]/`
   - 第三方文档、API 文档、技术规范、标准文档

2. **学习笔记** → `20_Areas/AI_Synthesized/Cluster_[主题]/`
   - 技术学习笔记、概念理解、实践总结

3. **设计文档** → `30_Resources/Library/Design/[分类]/`
   - UI/UX 设计说明、交互设计文档

4. **其他文档** → `30_Resources/Library/[分类]/`
   - 测试文档、会议记录等

**文件命名规则**：原文件名 + `_XXX` 后缀（或使用项目目录的时间戳部分）

**示例**：

```text
提取的文档：
- JWT_官方文档总结.md (参考资料)
- OAuth2_学习笔记.md (学习笔记)
- 登录流程设计.md (设计文档)

归档结果：
30_Resources/Library/Security/
  └── JWT_官方文档总结_XXX.md

20_Areas/AI_Synthesized/Cluster_Security/
  └── OAuth2_学习笔记_XXX.md

30_Resources/Library/Design/Auth/
  └── 登录流程设计_XXX.md
```

##### 6.2.3 添加元数据

为每个归档的文档添加 YAML front matter：

```markdown
---
created: 2026-01-13
source_project: XXX
source_path: 10_Projects/20260113_143000_XXX/docs/JWT_官方文档总结.md
archived_date: 2026-01-13
type: 参考资料
topic: 认证授权
keywords: [JWT, 认证, 安全]
---
```

#### 6.3 生成知识片段

将提取的可复用知识转化为**知识片段**，写入 `20_Areas/AI_Synthesized/`：

**知识片段格式**：

```markdown
---
created: 2026-01-13
source: 10_Projects/20260113_143000_XXX/Manual/JWT实现方案.md
topic: 认证授权
keywords: [JWT, 认证, 安全]
status: 待蒸馏
---

# JWT 认证方案（来自 XXX 项目）

## 核心设计
使用 JWT 作为无状态认证方案，Token 存储在 HTTP-Only Cookie 中。

## 续期机制
- Access Token 有效期：15 分钟
- Refresh Token 有效期：7 天
- 前端在 Access Token 过期前 5 分钟自动续期

## 安全措施
1. Token 签名使用 RS256 算法
2. 敏感信息不存储在 Token 中
3. 实现 Token 黑名单机制（登出时加入）

## 经验教训
- 不要在 Token 中存储敏感数据
- Refresh Token 需要持久化存储（Redis）
- 考虑 Token 过期后的用户体验

**来源项目**：XXX (已归档到 `40_Archives/20260113_143000_XXX/`)
```

**保存路径**：`20_Areas/AI_Synthesized/Cluster_Security/20260113_JWT认证方案_XXX.md`

#### 6.4 更新 COMPLETED.md 待办事项状态

知识提取和归档完成后，更新 `COMPLETED.md` 中的待办事项：

- 将所有已完成的待办事项标记为 `[x]`
- 如果某个待办事项未找到对应文件，标记为 `[!]` 并说明原因

---

### 步骤 7：移动到 Archives

将整个项目目录（包含更新后的 `COMPLETED.md`）移动到 `40_Archives/`，保留完整结构：

```text
10_Projects/20260113_143000_XXX/  →  40_Archives/20260113_143000_XXX/
```

**归档路径规则**：

- 直接归档到 `40_Archives/` 目录下
- 保持原目录名（时间戳在前，名称在后）：`20260113_143000_XXX`

**完整结构**：

```text
40_Archives/
└── 20260113_143000_XXX/
    ├── Manual/              # 保留项目的架构决策文档
    ├── AI_Generated/        # 保留所有开发记录
    ├── docs/                # 保留原始资料（已提取的也会保留）
    ├── design/              # 保留原始设计文档（已提取的也会保留）
    └── COMPLETED.md         # 包含项目总结和归档记录的完整文档
```

---

### 步骤 8：生成归档报告

```markdown
# Archiver 执行报告

**执行时间**：2026-01-13 12:00:00

## 本次归档项目

### ✅ XXX（项目）

- **归档路径**：`40_Archives/20260113_143000_XXX/`
- **完成日期**：2026-01-13
- **项目周期**：X 天（2026-01-01 至 2026-01-13）
- **COMPLETED.md**：已生成/更新，包含项目总结和归档待办事项
- **提取知识片段**：3 个
- **归档资料文档**：4 个

**COMPLETED.md 位置**：`40_Archives/20260113_143000_XXX/COMPLETED.md`

**知识片段详情**：
1. `20_Areas/AI_Synthesized/Cluster_Security/20260113_JWT认证方案_XXX.md`
2. `20_Areas/AI_Synthesized/Error_Patterns/20260113_邮件超时_XXX.md`
3. `20_Areas/AI_Synthesized/Cluster_Redis/20260113_缓存策略_XXX.md`

**归档资料文档详情**：
1. `30_Resources/Library/Security/JWT_官方文档总结_XXX.md`（参考资料）
2. `30_Resources/Library/Security/安全最佳实践_XXX.md`（参考资料）
3. `20_Areas/AI_Synthesized/Cluster_Security/OAuth2_学习笔记_XXX.md`（学习笔记）
4. `30_Resources/Library/Design/Auth/登录流程设计_XXX.md`（设计文档）

## 统计

- 归档项目数：2
- 生成/更新 COMPLETED.md：2 个
- 提取知识片段：5 个
- 归档资料文档：6 个
- 释放 Projects 区空间：约 150MB

**归档分布**：
- 参考资料 → `30_Resources/Library/`：3 个
- 学习笔记 → `20_Areas/AI_Synthesized/`：2 个
- 设计文档 → `30_Resources/Library/Design/`：1 个

## 当前 Projects 状态

- 活跃项目数：2
- 建议：定期归档，保持 Projects 轻量

## 下一步

1. **知识片段**已进入 `20_Areas/AI_Synthesized/`，等待 `Synthesizer` 和 `Auditor` 处理
2. **资料文档**已分类归档到相应 Area，可直接使用
3. **COMPLETED.md** 已保存在归档目录，可随时查阅项目总结和归档记录
```

将报告保存到：`20_Areas/AI_Synthesized/Weekly_Logs/Archiver_20260113.md`

---

### 步骤 9：清理与确认

归档完成后：

1. 确认原项目已从 `10_Projects/` 删除
2. 确认归档文件完整保存在 `40_Archives/`（包含更新后的 `COMPLETED.md`）
3. 确认知识片段已写入 `20_Areas/AI_Synthesized/`
4. 确认资料文档已分类归档到相应位置（`30_Resources/Library/` 或 `20_Areas/`）
5. 确认 `COMPLETED.md` 中的待办事项已全部标记为完成

---

## 安全检查

在执行任何文件操作前，必须：

- [ ] 验证项目路径在 `10_Projects/` 内
- [ ] 验证归档路径在 `40_Archives/` 内
- [ ] 验证知识片段写入路径在 `20_Areas/AI_Synthesized/` 内
- [ ] 验证资料文档归档路径在 `30_Resources/Library/` 或 `20_Areas/AI_Synthesized/` 内
- [ ] **绝对不能修改** `20_Areas/Manual/` 中已存在的文件
- [ ] 移动项目前先复制，确认完整后再删除原文件

---

## 特殊情况处理

### 情况 1：手动归档未完成项目

使用 `@pkm archive <项目名>` 可以归档没有 `COMPLETED.md` 的项目：

- 正常执行归档流程（会生成 `COMPLETED.md`）
- 在生成的 `COMPLETED.md` 中标注"手动归档（未完成）"
- **生成 COMPLETED.md 后会暂停，等待用户确认**
- 用户确认后继续执行归档
- 在归档报告中标注"手动归档（未完成）"
- 建议用户补充完成说明

**注意**：
- 即使项目已有 `COMPLETED.md`，归档时也会重新生成并替换
- 手动模式下，生成 COMPLETED.md 后必须等待用户确认才能继续

### 情况 2：项目无可提取知识

如果项目的 `Manual/` 和 `AI_Generated/` 都很简单，且没有资料文档：

- 正常归档（仍会生成 `COMPLETED.md`）
- `COMPLETED.md` 中的待办事项表为空或标记为"无需提取"
- 不生成知识片段，不归档资料文档
- 在报告中标注"无需提取知识"

### 情况 3：归档失败

如果移动文件时出错：

- **立即中止**
- 不删除原项目
- 记录错误日志
- 提示用户手动处理

---

## 关键原则

1. **先总结后归档**：归档前先生成/更新 `COMPLETED.md`，包含项目总结和待办事项表
2. **校验完善性**：生成 `COMPLETED.md` 后必须校验内容完善性和可信度，通过后才能继续
3. **基于待办事项**：根据 `COMPLETED.md` 中的待办事项表进行知识提取和归档
4. **安全第一**：先复制后删除，确保数据不丢失
5. **知识提取**：归档不是简单的移动，要提取可复用知识和资料文档
6. **可追溯**：每个知识片段和资料文档都标注来源项目
7. **尊重用户决策**：疑似完成的项目不自动归档，需用户确认
8. **分类归档**：知识片段写入 AI_Synthesized，资料文档分类归档到相应 Area
9. **始终更新 COMPLETED.md**：无论项目是否已有 `COMPLETED.md`，归档时都要重新生成并替换

---

## 预期效果

通过 Archiver，实现：

- ✅ Projects 区保持轻量（只有活跃项目）
- ✅ 历史项目完整归档，可随时查阅
- ✅ 项目经验自动回流到知识库（知识片段）
- ✅ 项目资料自动分类归档到 Area（参考资料、学习笔记等）
- ✅ 形成"项目 → 经验 → 知识"的正反馈循环
- ✅ 完成 CODE 闭环的最后一环

---

## 补充说明

### Archives 目录组织

```text
40_Archives/
├── 20251215_143000_XXX/
├── 20251230_150000_XXX/
├── 20260113_143000_XXX/
└── 20260113_160000_XXX/
```

### 建议的归档策略

- **项目完成后及时归档**：在项目中创建 `COMPLETED.md`，系统会自动归档
- **定期检查**：执行 `@pkm` 自动归档所有完成的项目
- **手动归档**：使用 `@pkm archive <项目名>` 手动归档特定项目
- **保留 1 年内的归档**：方便随时查阅
- **1 年后压缩**：将 1 年前的归档打包成 `.tar.gz`（可选）
- **3 年后删除**：彻底删除 3 年前的项目归档（可选）

### 知识回流的价值

归档不是"扔掉"，而是"升华"：

- **知识片段**：项目完成 → 经验提取 → 知识沉淀 → 未来复用
- **资料文档**：项目资料 → 分类归档 → 长期保存 → 随时查阅
- 每次归档都是知识库的一次进化，既沉淀经验，又保存资料

---
